<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GS 철강 제조 공정 도우미 - Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="chat.css" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
</head>
<body>
  <div class="app">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="topbar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 5h12M3 9h12M3 13h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
        <a href="index.html" class="topbar-title" style="text-decoration: none; color: inherit; cursor: pointer;">GS철강제조공정도우미</a>
      </div>
      <div class="topbar-right">
        <button class="topbar-btn" onclick="startNewConversation()" title="새 대화 시작" style="padding: 6px 14px; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px;">
          <svg width="16" height="16" viewBox="0 0 18 18" fill="none"><path d="M9 3v12M3 9h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          새 대화
        </button>
        <button class="topbar-btn" onclick="toggleInsightPanel()" title="인사이트 패널">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="2" y="2" width="14" height="14" rx="3" stroke="currentColor" stroke-width="1.3"/><path d="M11 2v14" stroke="currentColor" stroke-width="1.3"/></svg>
        </button>
      </div>
    </div>

    <div class="main-area">

      <!-- SIDEBAR -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-bottom">
          <button class="sidebar-bottom-btn" onclick="openKBUpdateModal()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v4M8 10v4M2 8h4M10 8h4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
            KB 업데이트
          </button>
          <button class="sidebar-bottom-btn">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.3"/><path d="M8 5.5v1.7l1.2 1.2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
            Settings
          </button>
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat-column">
        <div class="chat-messages" id="chatMessages">

          <!-- Empty state (shown when no messages) -->
          <div class="chat-empty" id="chatEmpty">
            <div class="chat-empty-icon">
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 2C6.03 2 2 5.58 2 10c0 2.17 1.06 4.13 2.76 5.52L3.5 19.5l4.4-1.96C8.9 17.83 9.93 18 11 18c4.97 0 9-3.58 9-8s-4.03-8-9-8z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
            </div>
            <h3>다이캐스팅 AI 도우미</h3>
            <p>현장 상황을 자연어로 입력하면<br />AI가 품질 예측, 원인 분석, 공정 지식 검색을 수행합니다.</p>
            <div class="sample-questions">
              <div class="sample-q" onclick="sendSample(this)">현재 조건에서 불량 가능성은?</div>
              <div class="sample-q" onclick="sendSample(this)">용탕 온도가 품질에 미치는 영향</div>
              <div class="sample-q" onclick="sendSample(this)">사출 압력 권장 범위 알려줘</div>
              <div class="sample-q" onclick="sendSample(this)">금형 온도 센서 스펙 확인</div>
            </div>
          </div>

        </div>

        <!-- DATA PANEL -->
        <div class="data-panel" id="dataPanel">
          <div class="data-panel-header">
            <span>공정 데이터 (30 변수)</span>
            <button class="data-panel-reset" onclick="resetFeatures()">기본값 복원</button>
          </div>
          <div class="data-panel-grid" id="dataPanelGrid">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- INPUT -->
        <div class="chat-input-area">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <button class="data-panel-toggle" id="dataPanelToggle" onclick="toggleDataPanel()">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><circle cx="5" cy="4" r="1.5" fill="currentColor"/><circle cx="11" cy="8" r="1.5" fill="currentColor"/><circle cx="7" cy="12" r="1.5" fill="currentColor"/></svg>
              공정 데이터
            </button>
          </div>
          <div class="chat-input-box">
            <textarea id="chatInput" rows="1" placeholder="현장 상황을 입력하세요..." oninput="autoGrow(this); toggleSend();" onkeydown="handleKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 13V9l10-5L3 3v4l6 1-6 1z" fill="#0B1220"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- INSIGHT PANEL -->
      <div class="insight-panel" id="insightPanel">
        <div class="insight-empty" id="insightEmpty">
          <div class="insight-empty-icon">📊</div>
          <p>질문하면 관련 인사이트가<br/>여기에 표시됩니다</p>
        </div>
        
        <!-- Dynamic content area -->
        <div class="insight-content" id="insightContent" style="display: none;">
          <!-- Charts, equipment cards, sensor info will be injected here -->
        </div>
      </div>

    </div>
  </div>

  <!-- KB UPDATE MODAL -->
  <div class="kb-modal-overlay" id="kbModal">
    <div class="kb-modal">
      <div class="kb-modal-header">
        <div class="kb-modal-title">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2v6M10 12v6M2 10h6M12 10h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Knowledge Base 업데이트
        </div>
        <button class="kb-modal-close" onclick="closeKBUpdateModal()">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M5 5l8 8M13 5l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="kb-modal-body">
        <div class="kb-modal-desc">
          현재 S3에 업로드된 문서를 청킹한 후 임베딩하여 Knowledge Base를 갱신합니다.<br/>
          이 작업은 몇 분 정도 소요될 수 있습니다.
        </div>
        <div class="kb-status-box">
          <div class="kb-status-row">
            <span class="kb-status-label">상태</span>
            <span class="kb-status-value" id="kbStatusValue">대기 중</span>
          </div>
          <div class="kb-status-row">
            <span class="kb-status-label">Job ID</span>
            <span class="kb-status-value" id="kbJobId">-</span>
          </div>
          <div class="kb-status-row">
            <span class="kb-status-label">처리된 문서</span>
            <span class="kb-status-value" id="kbDocsCount">-</span>
          </div>
          <div class="kb-status-row">
            <span class="kb-status-label">마지막 업데이트</span>
            <span class="kb-status-value" id="kbLastUpdate">-</span>
          </div>
        </div>
      </div>
      <div class="kb-modal-actions">
        <button class="kb-btn kb-btn-secondary" onclick="closeKBUpdateModal()">닫기</button>
        <button class="kb-btn kb-btn-primary" id="kbStartBtn" onclick="startKBIngest()">인제스트 시작</button>
      </div>
    </div>
  </div>

  <script src="chat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

</body>
</html>
